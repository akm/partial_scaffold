<h1>New <%= controller_singular_name %></h1>

<%% form_for :<%= controller_singular_name %>, @<%= controller_singular_name %>, 
    :url => url_for(:controller => '<%= controller_name %>', :action => 'create') do |f| -%>
  <div class="content_pane">
    <script>var base_pane_controller = new PartialResource.New("<%= controller_plural_name %>");</script>
    <%%= f.error_messages %>
    <%%= render :partial => "new", :locals => {:f => f} %>
  </div>

  <% sub_controllers.each do |sub_controller| -%>
    <% 
       reflection = sub_controller_reflections[sub_controller]
       sub_controller_name = sub_controller_names[sub_controller] 
       singularized_name = sub_controller_name.singularize
       sub_controller_full_name = "#{controller_name}/#{sub_controller_name}"
       base_name = "#{controller_name}_#{sub_controller_name}"
       pane_controller = "pane_controller_#{base_name}"
       options = {
         'content_pane' => "content_pane_#{base_name}",
         'field_names_to' => {
           singularized_name => (reflection.macro == :has_many) ? 
             "#{controller_singular_name}[#{sub_controller.to_s}_attrs][]" :
             "#{controller_singular_name}[#{sub_controller.to_s}_attrs]"
         }
       }
       if reflection.macro == :has_many
         options['action_pane'] = "action_pane_#{base_name}"
         options['pane_class_name'] = "item_content_pane_#{base_name} item_content_pane"
       end

       def to_js_object_string(obj) 
         if obj.is_a?(Hash)
           '{' << obj.map{|k,v| "#{k.inspect}:#{to_js_object_string(v)}"}.join(',') << '}'
         else
           obj.inspect
         end
       end
       options_js = to_js_object_string(options)
    -%>

    <h2><%= sub_controller_name %></h2>
    <script>
    var <%= pane_controller %> = base_pane_controller.<%= reflection.macro.to_s %>("<%= sub_controller_full_name %>",
        <%= options_js -%>);
    </script>
    <% if reflection.macro == :has_one -%>

      <div id="<%= options['content_pane'] %>" class="content_pane">
        <%% @<%= singularized_name %> = @<%= controller_singular_name %>.<%= sub_controller %> || <%= reflection.class_name %>.new -%>
        <%%= render :partial => "<%= sub_controller_full_name %>/new" %>
        <%% @<%= singularized_name %> = nil -%>
      </div>
      <script><%= pane_controller %>.activate();</script>

    <% else -%>
      <div class="content_pane">
        <div id="<%= options['content_pane'] %>">
          <%% @<%= controller_singular_name %>.<%= sub_controller_name %>.each do |<%= singularized_name %>| -%>
            <div class="<%= options['pane_class_name'] %>">
              <%% @<%= singularized_name %> = <%= singularized_name %> -%>
              <%%= render :partial => "<%= sub_controller_full_name %>/new" %>
              <%% @<%= singularized_name %> = nil -%>
            </div>
          <%% end -%>
        </div>
        <div id="<%= options['action_pane'] %>" class="action_pane">
          <a href="javascript:void(0)" class="link_to_add">Add</a>
        </div>
        <script><%= pane_controller %>.activate();</script>
      </div>

    <% end -%>

  <% end -%>

  <%%= submit_tag "Create" -%>
<%% end  %>

<%%= link_to 'Back', :controller => '<%= controller_file_path %>', :action => 'index' %>
